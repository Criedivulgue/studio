rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Função auxiliar para verificar se o usuário é um superadmin.
    function isSuperAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    // Função para validar a estrutura de um Contato
    function isContactDataValid() {
      let data = request.resource.data;
      return data.name is string &&
             data.email is string &&
             data.whatsapp is string &&
             data.phone is string &&
             data.status is string && (data.status == 'active' || data.status == 'inactive') &&
             data.interesses is list &&
             data.ownerId is string;
    }

    // Regras para a coleção 'users'
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isSuperAdmin();
      allow read: if userId == 'superadmin';

      // Sub-coleções de users (exceto contatos, que agora é raiz)
      match /ai-configs/{configId} {
        allow read, write: if request.auth.uid == userId || isSuperAdmin();
      }
      match /groups/{groupId} {
        allow read, write: if request.auth.uid == userId || isSuperAdmin();
      }
    }

    // --- NOVA REGRA PARA A COLEÇÃO RAIZ 'contacts' ---
    match /contacts/{contactId} {
      // LEITURA, ATUALIZAÇÃO, DELEÇÃO: Permitido para o dono do contato ou superadmin.
      allow read, update, delete: if request.auth != null && (resource.data.ownerId == request.auth.uid || isSuperAdmin());

      // CRIAÇÃO:
      // 1. Permitido para qualquer usuário logado (admin/superadmin) que passe dados válidos.
      // 2. Permitido para visitantes anônimos (leads do chat) que passem dados válidos.
      allow create: if (request.auth != null || request.auth == null) && isContactDataValid();
    }

    // Regra para o super-admin poder listar todos os contatos.
    match /{path=**}/contacts/{contactId} {
      allow read: if isSuperAdmin();
    }

    // Regras para sessões de chat e mensagens (sem alterações)
    match /chatSessions/{sessionId} {
      allow read, write: if request.auth != null && (resource.data.adminId == request.auth.uid || isSuperAdmin());
    }
    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if true;
    }
  }
}